<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />

<link rel="stylesheet" type="text/css" media="screen,print" href="https://x3dom.org/download/dev/x3dom.css" />
<link rel="stylesheet" type="text/css" media="screen,print" href="style.css" />

<title>X3DOM + glTF Loader</title>
<script src="../../sampleModels/model-index.js"></script>
<script src="../../tutorialModels/model-index.js"></script>
</head>
<body>

<!-- jquery.js v2.2.4 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.js"></script>

<!-- x3dom.debug.js 1.7.3-dev -->
<script src="https://x3dom.org/download/dev/x3dom.debug.js"></script>

<!-- x3dom patches -->
<script>
x3dom.glTF.glTFLoader.prototype.loadMaterial = function(gl, materialNode)
{    return new x3dom.glTF.glTFKHRMaterialCommons();

    if(materialNode){
        if(materialNode.extensions != null && materialNode.extensions.KHR_materials_common != null)
        {
            materialNode = materialNode.extensions.KHR_materials_common;

            var material = new x3dom.glTF.glTFKHRMaterialCommons();

            material.technique = glTF_KHR_MATERIAL_COMMON_TECHNIQUE[materialNode.technique];
            material.doubleSided = materialNode.doubleSided;

            for(var key in materialNode.values)
                if(materialNode.values.hasOwnProperty(key))
                {
                    var value = materialNode.values[key];
                    if(typeof value === 'string')
                    {
                        material[key+"Tex"] = this.loadTexture(gl, value);
                    }
                    else
                    {
                        material[key] = value;
                    }
                }

            return material;
        }else
        {
            var technique = this.scene.techniques[materialNode.technique];
            var program = this.loadShaderProgram(gl, technique.program);

            var material = new x3dom.glTF.glTFMaterial(technique);
            material.program = program;

            for(var key in technique.parameters) {
                if (!technique.parameters.hasOwnProperty(key)) continue;

                var parameter = technique.parameters[key];
                if(parameter.value != null){
                    material.values[key] = parameter.value;
                }
            }

            for(var key in materialNode.values)
                if(materialNode.values.hasOwnProperty(key))
                {
                    var value = materialNode.values[key];
                    if(typeof value === 'string')
                    {
                        material.textures[key] = this.loadTexture(gl, value);
                    }
                    else
                    {
                        material.values[key] = value;
                    }
                }

            return material;
        }
    }

    return new x3dom.glTF.glTFKHRMaterialCommons();
};

</script>
    
<x3d id="x3d" width="100%" height="100%"> 
    <scene>
        <Environment frustumCulling='false'></Environment>
        <Viewpoint id="vp" position="0 0 5" zNear="0.01" zFar="10000"></Viewpoint>
        <navigationInfo id="head" headlight='true' type='"EXAMINE"'>  </navigationInfo>
        <DirectionalLight direction="0, -1, -1"></DirectionalLight>
        <Transform DEF="model" rotation="0 1 0 0" id="gltf">
            <!-- <ExternalShape id="exshape" url="https://cdn.rawgit.com/cx20/gltf-test/master/sampleModels/Duck/glTF-Binary/Duck.glb"></ExternalShape> -->
        </Transform>                
        <timeSensor DEF="time" cycleInterval="40" loop="true"></timeSensor>
        <OrientationInterpolator DEF="move" key="0 0.5 1" keyValue="0 1 0 0, 0 1 0 3.14, 0 1 0 6.28"></OrientationInterpolator>
        <Route fromNode="time" fromField ="fraction_changed" toNode="move" toField="set_fraction"></Route>
        <Route fromNode="move" fromField ="value_changed" toNode="model" toField="rotation"></Route>
    </scene> 
</x3d> 

<script src="index.js"></script>
</body>
</html>
